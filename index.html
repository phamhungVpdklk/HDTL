<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QL Số HĐ & TL – VPĐKLK</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .badge{display:inline-block;padding:.25rem .55rem;border-radius:.5rem;font-weight:700}
    .badge-hd{background:#eaf2ff;color:#1d4ed8;border:1px solid #bfdbfe}
    .badge-tl{background:#fff0e6;color:#d97706;border:1px solid #fed7aa}
    .badge-void{background:#ffe0e0;color:#c00;border:1px solid #fca5a5;text-decoration:line-through}
    .btn{padding:.6rem 1rem;border-radius:.7rem;font-weight:600;border:1px solid #e5e7eb;background:white}
    .btn-primary{background:#1d4ed8;color:#fff;border-color:#1d4ed8}
    .btn-warn{background:#d97706;color:#fff;border-color:#d97706}
    .btn-ghost{background:#f8fafc}
    .card{border:1px solid #e5e7eb;border-radius:1rem;padding:1rem;background:#fff}
    .table{width:100%}
    .table th,.table td{padding:.55rem .6rem;border-bottom:1px solid #f1f5f9}
  </style>
</head>
<body class="bg-slate-50">
  <!-- Navbar -->
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-3 py-3 flex items-center gap-3">
      <div class="flex-1 flex items-center gap-3">
        <span class="text-xl font-bold">QL Số HĐ & TL – VPĐKLK</span>
        <nav class="hidden sm:flex gap-4 ml-4 text-slate-600">
          <a class="hover:text-slate-900" href="./index.html">Trang chính</a>
          <a class="hover:text-slate-900" href="./reports.html">Báo cáo</a>
        </nav>
      </div>
      <div class="flex items-center gap-2">
        <input id="email" class="hidden sm:block border rounded px-3 py-2" placeholder="email (vd: user1@vp.local)" />
        <input id="password" type="password" class="hidden sm:block border rounded px-3 py-2" placeholder="mật khẩu" />
        <button id="btnLogin" class="btn btn-primary">Đăng nhập</button>
        <button id="btnLogout" class="btn btn-ghost">Đăng xuất</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-3 py-6">
    <!-- Info -->
    <section class="grid md:grid-cols-3 gap-3">
      <div class="card"><div class="text-slate-500">Người dùng</div><div id="who" class="text-lg font-semibold">Chưa đăng nhập</div></div>
      <div class="card"><div class="text-slate-500">Phiên</div><div id="session" class="text-lg font-semibold">–</div></div>
      <div class="card"><div class="text-slate-500">Điều hướng</div><div class="text-lg"><a class="text-blue-700 underline" href="./reports.html">Mở Báo cáo & Thống kê</a></div></div>
    </section>

    <!-- Issue Contract -->
    <section class="mt-6 card">
      <h2 class="text-xl font-bold">Cấp số Hợp đồng</h2>
      <div class="grid sm:grid-cols-6 gap-3 mt-3">
        <div><label class="text-sm">Phường</label>
          <select id="ward" class="border rounded w-full px-3 py-2"><option>LK</option><option>HG</option><option>BL</option><option>BV</option><option>XL</option></select>
        </div>
        <div class="sm:col-span-2"><label class="text-sm">Tên chủ đất</label>
          <input id="owner" class="border rounded w-full px-3 py-2" placeholder="Nguyễn Văn A" />
        </div>
        <div><label class="text-sm">Số tờ</label><input id="sheet" type="number" class="border rounded w-full px-3 py-2" /></div>
        <div><label class="text-sm">Số thửa</label><input id="parcel" type="number" class="border rounded w-full px-3 py-2" /></div>
        <div><label class="text-sm">Ghi chú</label><input id="note" class="border rounded w-full px-3 py-2" /></div>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="btnIssueHD" class="btn btn-primary">Cấp số HĐ</button>
        <div id="hdResult" class="text-lg"></div>
      </div>
    </section>

    <!-- Contracts table -->
    <section class="mt-6 card">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold">Danh sách Hợp đồng gần đây</h2>
        <div class="flex gap-2">
          <select id="filterWard" class="border rounded px-2 py-1">
            <option value="">Tất cả phường</option>
            <option>LK</option><option>HG</option><option>BL</option><option>BV</option><option>XL</option>
          </select>
          <button id="btnReload" class="btn">Tải lại</button>
        </div>
      </div>
      <div class="mt-3 overflow-x-auto">
        <table class="table">
          <thead class="text-left text-slate-500"><tr><th>Số HĐ</th><th>Phường</th><th>Chủ đất</th><th>Tờ</th><th>Thửa</th><th>Trạng thái</th><th>Hành động</th></tr></thead>
          <tbody id="contractsBody"></tbody>
        </table>
      </div>
      <p class="text-sm text-slate-500 mt-2">→ Bấm <b>Cấp TL</b> ở dòng HĐ tương ứng để cấp số thanh lý. Số HĐ & TL hiển thị dạng <span class="badge badge-hd">nổi bật</span>. Có nút <b>Huỷ TL</b> và <b>Huỷ HĐ</b> khi cần.</p>
    </section>
  </main>

  <div id="toast" class="fixed bottom-4 right-4 hidden bg-slate-900 text-white px-4 py-3 rounded-lg shadow-lg"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://nefjhmhzfuuwxxhhjaei.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZmpobWh6ZnV1d3h4aGhqYWVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTI3MzQsImV4cCI6MjA3MTY4ODczNH0.2vT6kw0uvSTr49cGLSrsZbT6qtPJ_mYzXsu7PGJpGrY";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const gi = (id)=>document.getElementById(id);
    const toast = (msg)=>{const t=gi('toast');t.textContent=msg;t.classList.remove('hidden');setTimeout(()=>t.classList.add('hidden'),2500);};

    async function refreshWho(){
      const { data: { session} } = await sb.auth.getSession();
      const reportsLink = document.querySelector('a[href="./reports.html"]');
      if (!session){
        gi('who').textContent="Chưa đăng nhập";
        gi('session').textContent="–";
        if(reportsLink) reportsLink.style.display='none';
        return;
      }
      const role=session.user.app_metadata?.role;
      gi('who').textContent=session.user.email+(role?" ("+role+")":"");
      gi('session').textContent=session.access_token.slice(0,12)+"…";
      if(reportsLink) reportsLink.style.display=(role==='admin'||role==='report_admin')?'':'none';
    }

    gi('btnLogin').onclick=async()=>{
      const {error}=await sb.auth.signInWithPassword({email:gi('email').value.trim(),password:gi('password').value});
      if(error) alert(error.message); else { toast("Đăng nhập thành công"); refreshWho(); loadContracts(); }
    };
    gi('btnLogout').onclick=async()=>{ await sb.auth.signOut(); refreshWho(); };

    async function ensureSession(){ const { data: { session } }=await sb.auth.getSession(); if(!session) throw new Error("Chưa đăng nhập"); }

    gi('btnIssueHD').onclick=async()=>{
      try{
        await ensureSession();
        const payload={
          p_ward:gi('ward').value,
          p_owner_name:gi('owner').value,
          p_sheet_no:+gi('sheet').value,
          p_parcel_no:+gi('parcel').value,
          p_request_id:crypto.randomUUID(),
          p_note:gi('note').value||null
        };
        const {data,error}=await sb.rpc('issue_contract',payload);
        if(error) throw error;
        gi('hdResult').innerHTML=`<span class="badge badge-hd">${data.contract_no}</span>`;
        toast("Đã cấp: "+data.contract_no);
        loadContracts();
      }catch(e){ alert("Lỗi: "+e.message); }
    };

    async function loadContracts(){
      try{ await ensureSession(); }catch{ return; }

      // lấy danh sách HĐ
      const ward=gi('filterWard').value;
      let q=sb.from('contract')
        .select('id,contract_no,ward,owner_name,sheet_no,parcel_no,status')
        .order('id',{ascending:false})
        .limit(100);
      if(ward) q=q.eq('ward',ward);
      const {data:contracts,error}=await q;
      if(error){ alert(error.message); return; }

      // lấy TL đang hiệu lực theo contract_id
      const ids = contracts.map(r=>r.id);
      let tlMap = new Map();
      if (ids.length){
        const { data: tls, error: e2 } = await sb.from('termination')
          .select('contract_id, termination_no, status')
          .in('contract_id', ids)
          .eq('status','issued');
        if (e2){ alert(e2.message); return; }
        for (const t of tls) tlMap.set(t.contract_id, t.termination_no);
      }

      // render bảng
      const tbody=gi('contractsBody'); tbody.innerHTML='';
      for(const r of contracts){
        const tlNo = tlMap.get(r.id);
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><span class="badge ${r.status==='void'?'badge-void':'badge-hd'}">${r.contract_no}</span></td>
          <td>${r.ward}</td>
          <td>${r.owner_name??''}</td>
          <td>${r.sheet_no??''}</td>
          <td>${r.parcel_no??''}</td>
          <td>${r.status}</td>
          <td>
            ${r.status==='void'
              ? '<span class="text-slate-400">—</span>'
              : tlNo
                ? '<span class="badge badge-tl">'+tlNo+'</span> '+
                  '<button class="btn btn-ghost btn-sm" data-act="void-tl" data-no="'+tlNo+'">Huỷ TL</button>'
                : '<button class="btn btn-warn btn-sm" data-act="issue-tl" data-no="'+r.contract_no+'" data-ward="'+r.ward+'">Cấp TL</button>'
            }
            ${r.status!=='void'
              ? ' <button class="btn btn-ghost btn-sm" data-act="void-hd" data-no="'+r.contract_no+'">Huỷ HĐ</button>'
              : ''
            }
          </td>`;
        tbody.appendChild(tr);
      }

      // gắn handler: cấp TL / huỷ TL / huỷ HĐ
      tbody.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click', async (ev)=>{
          const el = ev.currentTarget;
          const act = el.getAttribute('data-act');

          if (act === 'issue-tl'){
            const contractNo = el.getAttribute('data-no');
            const ward = el.getAttribute('data-ward');
            el.disabled = true; el.textContent = 'Đang cấp...';
            try{
              await ensureSession();
              const { data, error } = await sb.rpc('issue_termination',{
                p_ward: ward,
                p_contract_no: contractNo,
                p_request_id: crypto.randomUUID(),
                p_note: null
              });
              if (error) throw error;
              toast("Đã cấp TL: "+data.termination_no);
              await loadContracts();
            }catch(e){
              alert("Lỗi TL: "+e.message);
              el.disabled=false; el.textContent='Cấp TL';
            }
          }

          if (act === 'void-tl'){
            const tlNo = el.getAttribute('data-no');
            const reason = prompt("Nhập lý do huỷ TL (>= 20 ký tự):");
            if (!reason || reason.trim().length < 20){ alert("Lý do quá ngắn."); return; }
            el.disabled = true; el.textContent='Đang huỷ...';
            try{
              const { error } = await sb.rpc('void_record',{
                p_entity: 'TERMINATION',
                p_number: tlNo,
                p_reason_code: 'USER_VOID',
                p_reason_text: reason
              });
              if (error) throw error;
              toast("Đã huỷ TL: "+tlNo);
              await loadContracts();
            }catch(e){
              alert("Lỗi huỷ TL: "+e.message);
              el.disabled=false; el.textContent='Huỷ TL';
            }
          }

          if (act === 'void-hd'){
            const hdNo = el.getAttribute('data-no');
            const reason = prompt("Nhập lý do huỷ HĐ (>= 20 ký tự):\n(Lưu ý: nếu HĐ có TL hiệu lực sẽ không thể huỷ)");
            if (!reason || reason.trim().length < 20){ alert("Lý do quá ngắn."); return; }
            el.disabled = true; el.textContent='Đang huỷ...';
            try{
              const { error } = await sb.rpc('void_record',{
                p_entity: 'CONTRACT',
                p_number: hdNo,
                p_reason_code: 'USER_VOID',
                p_reason_text: reason
              });
              if (error) throw error;
              toast("Đã huỷ HĐ: "+hdNo);
              await loadContracts();
            }catch(e){
              alert("Lỗi huỷ HĐ: "+e.message);
              el.disabled=false; el.textContent='Huỷ HĐ';
            }
          }
        });
      });
    }
    gi('btnReload').onclick=loadContracts;
    gi('filterWard').onchange=loadContracts;

    refreshWho(); loadContracts();
  </script>
</body>
</html>

