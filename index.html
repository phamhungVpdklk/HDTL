<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>PH·∫¶N M·ªÄM QL Hƒê & TL ‚Äì VPƒêK LONG KH√ÅNH</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- THEME: Flat Design + Colors -->
  <style id="vpdk-theme">
    :root{
      --vpdk-bg:#f7f8fb; --vpdk-card:#ffffff; --vpdk-line:#e5e7eb;
      --vpdk-text:#0f172a; --vpdk-muted:#475569;
      --vpdk-primary:#2563eb; /* Hƒê */
      --vpdk-warn:#d97706;    /* TL */
      --vpdk-danger:#dc2626;  /* Hu·ª∑/Xo√° */
      --vpdk-neutral:#64748b; /* T·∫£i l·∫°i/Ph·ª• */
      --vpdk-focus:#93c5fd;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --vpdk-bg:#0b1020; --vpdk-card:#0f172a; --vpdk-line:#1f2937;
        --vpdk-text:#e5e7eb; --vpdk-muted:#94a3b8;
      }
    }
    html,body{ background:var(--vpdk-bg); color:var(--vpdk-text) }
    .flat{ background:var(--vpdk-card); border:1px solid var(--vpdk-line); border-radius:14px }
    input,select,button{ min-height:44px }
    input.flat,select.flat{ padding:.6rem .8rem }
    .btn{ appearance:none; user-select:none; border-radius:12px; border:1px solid var(--vpdk-line);
          padding:.6rem 1rem; font-weight:700; transition:.15s; display:inline-flex; gap:.5rem; align-items:center }
    .btn:hover{ transform:translateY(-1px) }
    .btn:active{ transform:translateY(0) }
    .btn:focus-visible{ outline:3px solid var(--vpdk-focus); outline-offset:2px }
    .btn-sm{ padding:.4rem .75rem; font-weight:600; border-radius:10px }
    .btn-block{ width:100% }
    .btn-primary{ background:var(--vpdk-primary); color:#fff; border-color:var(--vpdk-primary) }
    .btn-warn{ background:var(--vpdk-warn); color:#fff; border-color:var(--vpdk-warn) }
    .btn-danger{ background:var(--vpdk-danger); color:#fff; border-color:var(--vpdk-danger) }
    .btn-neutral{ background:#f1f5f9; color:#0f172a; border-color:var(--vpdk-line) }
    .btn-ghost{ background:#f8fafc; color:#0f172a }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none }
    .badge{ display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem;
            border-radius:10px; border:1px solid var(--vpdk-line); font-weight:800; letter-spacing:.2px }
    .badge-hd{ background:#e0eaff; color:#1d4ed8; border-color:#bfdbfe }
    .badge-tl{ background:#fff1e6; color:#a45303; border-color:#fed7aa }
    .badge-void{ background:#ffe0e0; color:#b91c1c; border-color:#fecaca;
                 text-decoration:line-through; text-decoration-thickness:2px }
    .table{ width:100% }
    .table th,.table td{ border-bottom:1px solid var(--vpdk-line); padding:.65rem .6rem; vertical-align:top }
    .pill{ display:inline-flex; align-items:center; gap:.4rem; padding:.3rem .7rem; border:1px solid var(--vpdk-line); border-radius:999px; font-size:.9rem; background:#f1f5f9; color:#334155 }
    .card-row{ border:1px solid var(--vpdk-line); border-radius:12px; background:#fff; padding:.9rem }
    .card-row h4{ font-weight:700; margin:0 0 .35rem }
    .card-row .meta{ font-size:.92rem; color:#475569; display:flex; flex-wrap:wrap; gap:.45rem .8rem }
    .card-row .actions{ margin-top:.6rem; display:flex; flex-wrap:wrap; gap:.4rem }
    .ic{ font-size:1.05em; line-height:1 }
    @media (max-width:640px){
      html{ font-size:15px }
      .sticky-actions{ position:sticky; bottom:0; left:0; right:0; background:#ffffffee; backdrop-filter:blur(6px);
        border-top:1px solid var(--vpdk-line); padding:.6rem; display:flex; gap:.5rem; z-index:30 }
    }

    /* Header v√†ng 3D n·ªÅn xanh */
    .header-title {
      font-size: 1.3rem;
      font-weight: 900;
      color: #FFD700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.4), 0 0 8px #fff59d;
    }
    .header-bar {
      background: linear-gradient(90deg, #38bdf8, #0ea5e9);
      padding: 1rem;
      text-align: center;
    }
    .btn-nav{border-radius:8px; padding:.35rem .8rem; font-weight:700; border:1px solid #cbd5e1; background:#f1f5f9; color:#0f172a;}
  </style>
</head>
<body>
  <!-- HEADER m·ªõi -->
  <header class="header-bar">
    <div class="flex flex-col items-center gap-2">
      <div class="flex items-center justify-center gap-2">
        <span class="text-2xl">üìë</span>
        <span class="header-title">PH·∫¶N M·ªÄM QU·∫¢N L√ù H·ª¢P ƒê·ªíNG & THANH L√ù VPƒêK LONG KH√ÅNH</span>
      </div>
      <nav class="flex gap-3">
        <a href="index.html" class="btn-nav">Trang ch√≠nh</a>
        <a id="reportsLink" href="reports.html" class="btn-nav">Trang b√°o c√°o</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-3 py-6">
    <section class="grid md:grid-cols-3 gap-3">
      <div class="flat p-3"><div class="text-[13px] text-slate-500">Ng∆∞·ªùi d√πng</div><div id="who" class="text-lg font-semibold">Ch∆∞a ƒëƒÉng nh·∫≠p</div></div>
      <div class="flat p-3"><div class="text-[13px] text-slate-500">Vai tr√≤</div><div id="role" class="text-lg font-semibold">‚Äì</div></div>
      <div class="flat p-3"><div class="text-[13px] text-slate-500">Phi√™n</div><div id="session" class="text-lg font-semibold">‚Äì</div></div>
    </section>

    <section class="flat p-4 mt-6">
      <h2 class="text-xl font-bold">C·∫•p s·ªë H·ª£p ƒë·ªìng (ƒë√°nh s·ªë to√†n c·ª•c)</h2>
      <div class="grid sm:grid-cols-6 grid-cols-2 gap-3 mt-3">
        <div class="sm:col-span-1 col-span-2">
          <label class="text-sm text-slate-600">Ph∆∞·ªùng</label>
          <select id="ward" class="flat px-3 py-2 w-full"><option>LK</option><option>HG</option><option>BL</option><option>BV</option><option>XL</option></select>
        </div>
        <div class="sm:col-span-2 col-span-2">
          <label class="text-sm text-slate-600">T√™n ch·ªß ƒë·∫•t</label>
          <input id="owner" class="flat px-3 py-2 w-full" placeholder="Nguy·ªÖn VƒÉn A" autocomplete="name" />
        </div>
        <div><label class="text-sm text-slate-600">S·ªë t·ªù</label><input id="sheet" type="number" inputmode="numeric" pattern="[0-9]*" class="flat px-3 py-2 w-full" /></div>
        <div><label class="text-sm text-slate-600">S·ªë th·ª≠a</label><input id="parcel" type="number" inputmode="numeric" pattern="[0-9]*" class="flat px-3 py-2 w-full" /></div>
        <div class="sm:col-span-2 col-span-2"><label class="text-sm text-slate-600">Ghi ch√∫</label><input id="note" class="flat px-3 py-2 w-full" /></div>
      </div>
      <div class="mt-3 flex gap-2 items-center">
        <button id="btnIssueHD" class="btn btn-primary"><span class="ic">üìÑ</span>C·∫•p s·ªë Hƒê</button>
        <div id="hdResult" class="text-lg"></div>
      </div>
    </section>

    <section class="flat p-4 mt-6">
      <div class="flex items-center justify-between gap-3">
        <h2 class="text-xl font-bold">Danh s√°ch H·ª£p ƒë·ªìng g·∫ßn ƒë√¢y</h2>
        <div class="flex gap-2 items-center">
          <select id="filterWard" class="flat px-2 py-2">
            <option value="">T·∫•t c·∫£ ph∆∞·ªùng</option><option>LK</option><option>HG</option><option>BL</option><option>BV</option><option>XL</option>
          </select>
          <button id="btnReload" class="btn btn-neutral">T·∫£i l·∫°i</button>
        </div>
      </div>
      <div class="mt-3 overflow-x-auto hidden sm:block">
        <table class="table">
          <thead class="text-left text-slate-500"><tr><th>S·ªë Hƒê</th><th>Ph∆∞·ªùng</th><th>Ch·ªß ƒë·∫•t</th><th>T·ªù</th><th>Th·ª≠a</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr></thead>
          <tbody id="contractsBody"></tbody>
        </table>
      </div>
      <div id="contractsCards" class="mt-3 grid gap-3 sm:hidden"></div>

      <p class="text-sm text-slate-500 mt-3">
        Tr·∫°ng th√°i hi·ªÉn th·ªã: <b>Ch∆∞a thanh l√Ω</b> / <b>Ho√†n th√†nh</b> / <b>ƒê√£ hu·ª∑</b>. &nbsp;S·ªë hu·ª∑:
        <span class="badge badge-void">VD Hƒê b·ªã hu·ª∑</span>
      </p>
    </section>

    <div class="sticky-actions sm:hidden">
      <button id="btnIssueHD_mobile" class="btn btn-primary btn-block"><span class="ic">üìÑ</span>C·∫•p s·ªë Hƒê</button>
      <button id="btnReload_mobile" class="btn btn-neutral btn-block">T·∫£i l·∫°i</button>
    </div>
  </main>

  <!-- FOOTER m·ªõi -->
  <footer class="bg-slate-100 text-slate-700 text-sm mt-6 py-4 px-4">
    <div class="max-w-6xl mx-auto space-y-2 text-center leading-relaxed">
      <p><b>Mi·ªÖn tr·ª´ tr√°ch nhi·ªám:</b> Ph·∫ßn m·ªÅm n√†y ch·ªâ ph·ª•c v·ª• m·ª•c ƒë√≠ch qu·∫£n l√Ω n·ªôi b·ªô VPƒêKLK.
         Ch√∫ng t√¥i kh√¥ng ch·ªãu tr√°ch nhi·ªám ph√°p l√Ω cho vi·ªác s·ª≠ d·ª•ng sai m·ª•c ƒë√≠ch.</p>
      <p>M·ªçi g√≥p √Ω xin g·ª≠i v·ªÅ üìß 
         <a href="mailto:phamhung16490@gmail.com" class="text-blue-600 underline">phamhung16490@gmail.com</a></p>
      <p><b>VƒÉn ph√≤ng ƒêƒÉng k√Ω ƒê·∫•t ƒëai chi nh√°nh Long Kh√°nh</b><br/>
         ƒê·ªãa ch·ªâ: ƒê∆∞·ªùng CMT8, Ph∆∞·ªùng Long Kh√°nh, t·ªânh ƒê·ªìng Nai</p>
      <p class="text-xs">¬© 2025 VPƒêKLK. All rights reserved.</p>
    </div>
  </footer>

  <div id="toast" class="fixed bottom-4 right-4 hidden text-white px-4 py-3 rounded-lg" style="background:#0f172a"></div>

  <!-- Login Modal -->
  <dialog id="loginDialog" class="rounded-xl p-0 w-[92vw] max-w-md">
    <form id="loginForm" method="dialog" class="p-5">
      <h3 class="text-lg font-semibold mb-3">ƒêƒÉng nh·∫≠p</h3>
      <div class="space-y-3">
        <div><label class="text-sm text-slate-600">Email</label><input id="emailModal" class="flat px-3 py-2 w-full" placeholder="vd: user1@vp.local" autocomplete="username" /></div>
        <div><label class="text-sm text-slate-600">M·∫≠t kh·∫©u</label><input id="passwordModal" type="password" class="flat px-3 py-2 w-full" placeholder="m·∫≠t kh·∫©u" autocomplete="current-password" /></div>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button type="button" id="btnCloseLogin" class="btn btn-ghost">Hu·ª∑</button>
        <button type="submit" id="btnDoLogin" class="btn btn-primary"><span class="ic">üîê</span>ƒêƒÉng nh·∫≠p</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://nefjhmhzfuuwxxhhjaei.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZmpobWh6ZnV1d3h4aGhqYWVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTI3MzQsImV4cCI6MjA3MTY4ODczNH0.2vT6kw0uvSTr49cGLSrsZbT6qtPJ_mYzXsu7PGJpGrY";  /* ‚Üê d√°n ANON KEY */
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const gi = (id)=>document.getElementById(id);
    const toast = (msg)=>{const t=gi('toast');t.textContent=msg;t.classList.remove('hidden');setTimeout(()=>t.classList.add('hidden'),2200);};
    const getSession = async()=> (await sb.auth.getSession()).data.session;
    const isVoid = (st)=> (st||'').toLowerCase()==='void';

    async function fetchRole(){
      const { data, error } = await sb.rpc('get_my_role');
      if (error){ console.error(error); return ''; }
      return data || '';
    }
    function vnContractStatus(r, tlMap){ return isVoid(r.status) ? 'ƒê√£ hu·ª∑' : (tlMap.has(r.id) ? 'Ho√†n th√†nh' : 'Ch∆∞a thanh l√Ω'); }

    async function refreshWho(){
      const session = await getSession();
      const reportsLink = document.getElementById('reportsLink');
      if (!session){
        gi('who').textContent="Ch∆∞a ƒëƒÉng nh·∫≠p"; gi('role').textContent="‚Äì"; gi('session').textContent="‚Äì";
        if (reportsLink) reportsLink.style.display=''; // v·∫´n hi·ªán link; quy·ªÅn s·∫Ω check trong reports.html
        return;
      }
      const email = (session.user.email || '').toLowerCase();
      const role  = await fetchRole();
      gi('who').textContent = session.user.email || '';
      gi('role').textContent = role || '(ch∆∞a g√°n)';
      gi('session').textContent = session.access_token.slice(0,12)+"‚Ä¶";
      // v·∫´n cho th·∫•y link, c√≤n h·∫°n ch·∫ø truy c·∫≠p n·∫±m ·ªü reports.html
      if (reportsLink) reportsLink.style.display = '';
    }

    // Modal login
    const dlg=gi('loginDialog'), emailModal=gi('emailModal'), passwordModal=gi('passwordModal');
    const openLoginDialog=()=>{ if(!dlg.open) dlg.showModal(); setTimeout(()=>emailModal.focus(),30); };
    const closeLoginDialog=()=>{ if(dlg.open) dlg.close(); };
    gi('btnCloseLogin').onclick = closeLoginDialog;
    gi('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const { error } = await sb.auth.signInWithPassword({ email: emailModal.value.trim(), password: passwordModal.value });
      if (error){ alert(error.message); return; }
      closeLoginDialog(); toast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng"); await refreshWho(); await loadContracts();
    });

    // Header login buttons (ch√∫ng ta d√πng modal n√™n kh√¥ng c√≥ input ·ªü header m·ªõi)
    document.querySelectorAll('#btnLogout').forEach(btn=> btn.addEventListener('click', async()=>{ await sb.auth.signOut(); await refreshWho(); }));

    // ====== C·∫•p s·ªë Hƒê: v·ªõi fallback ======
    const issueHd = async()=>{
      const s=await getSession(); if(!s){ openLoginDialog(); return; }
      try{
        const payload={
          p_ward:gi('ward').value,
          p_owner_name:gi('owner').value,
          p_sheet_no:+gi('sheet').value||null,
          p_parcel_no:+gi('parcel').value||null,
          p_request_id:crypto.randomUUID(),
          p_note:gi('note').value||null
        };
        const { data, error } = await sb.rpc('issue_contract_global', payload);
        if (error) throw error;

        const row = Array.isArray(data) ? data[0] : data;
        let cno = row?.contract_no;

        if (!cno){
          const { data: last } = await sb.from('contract').select('contract_no').order('id',{ascending:false}).limit(1);
          cno = last?.[0]?.contract_no || '(kh√¥ng l·∫•y ƒë∆∞·ª£c s·ªë)';
        }

        gi('hdResult').innerHTML = `<span class="badge badge-hd">${cno}</span>`;
        toast("ƒê√£ c·∫•p: " + cno);
        await loadContracts();
      }catch(e){ console.error(e); alert("L·ªói: "+(e.message||e)); }
    };
    gi('btnIssueHD').onclick = issueHd;
    gi('btnIssueHD_mobile').onclick = ()=> gi('btnIssueHD').click();

    // ====== Load list & actions ======
    async function loadContracts(){
      const s=await getSession(); if(!s) return;
      const role = await fetchRole();
      const ward=gi('filterWard').value;
      let q=sb.from('contract').select('id,contract_no,ward,owner_name,sheet_no,parcel_no,status').order('id',{ascending:false}).limit(100);
      if (ward) q=q.eq('ward', ward);
      const { data:contracts, error } = await q;
      if (error){ alert(error.message); return; }

      const ids=contracts.map(r=>r.id); const tlMap=new Map();
      if (ids.length){
        const { data: tls, error:e2 } = await sb.from('termination')
          .select('contract_id,termination_no,status').in('contract_id', ids).eq('status','issued');
        if (e2){ alert(e2.message); return; }
        for (const t of tls) tlMap.set(t.contract_id, t.termination_no);
      }

      // Desktop
      const tbody=gi('contractsBody'); tbody.innerHTML='';
      for (const r of contracts){
        const tlNo=tlMap.get(r.id);
        const actions=[];
        if (isVoid(r.status)){
          actions.push('<span class="text-slate-400">‚Äî</span>');
        } else {
          if (tlNo){
            actions.push(`<span class="badge badge-tl">${tlNo}</span>`);
            actions.push(`<button class="btn btn-danger btn-sm" data-act="void-tl" data-no="${tlNo}"><span class="ic">‚õî</span>Hu·ª∑ TL</button>`);
            if (role==='admin') actions.push(`<button class="btn btn-danger btn-sm" data-act="del-tl" data-no="${tlNo}">Xo√° TL</button>`);
          } else {
            actions.push(`<button class="btn btn-warn btn-sm" data-act="issue-tl" data-no="${r.contract_no}" data-ward="${r.ward}"><span class="ic">‚úÖ</span>C·∫•p TL</button>`);
          }
          actions.push(`<button class="btn btn-danger btn-sm" data-act="void-hd" data-no="${r.contract_no}"><span class="ic">‚õî</span>Hu·ª∑ Hƒê</button>`);
          if (role==='admin') actions.push(`<button class="btn btn-danger btn-sm" data-act="del-hd" data-no="${r.contract_no}">Xo√° Hƒê</button>`);
        }
        const statusLabel = isVoid(r.status) ? 'ƒê√£ hu·ª∑' : (tlMap.has(r.id) ? 'Ho√†n th√†nh' : 'Ch∆∞a thanh l√Ω');
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><span class="badge ${isVoid(r.status)?'badge-void':'badge-hd'}">${r.contract_no}</span></td>
          <td>${r.ward}</td><td>${r.owner_name??''}</td>
          <td>${r.sheet_no??''}</td><td>${r.parcel_no??''}</td>
          <td>${statusLabel}</td><td class="space-x-1 space-y-1">${actions.join(' ')}</td>`;
        tbody.appendChild(tr);
      }

      // Mobile
      const cards=gi('contractsCards'); cards.innerHTML='';
      for (const r of contracts){
        const tlNo=tlMap.get(r.id);
        const statusLabel = isVoid(r.status) ? 'ƒê√£ hu·ª∑' : (tlMap.has(r.id) ? 'Ho√†n th√†nh' : 'Ch∆∞a thanh l√Ω');
        const card=document.createElement('div'); card.className='card-row';
        const hdBadge=`<span class="badge ${isVoid(r.status)?'badge-void':'badge-hd'}">${r.contract_no}</span>`;
        const tlPart = isVoid(r.status) ? '<span class="text-slate-400">‚Äî</span>' :
          (tlNo ? `<span class="badge badge-tl">${tlNo}</span>
                   <button class="btn btn-danger btn-sm" data-act="void-tl" data-no="${tlNo}"><span class="ic">‚õî</span>Hu·ª∑ TL</button>
                   ${role==='admin'?`<button class="btn btn-danger btn-sm" data-act="del-tl" data-no="${tlNo}">Xo√° TL</button>`:''}`
               : `<button class="btn btn-warn btn-sm" data-act="issue-tl" data-no="${r.contract_no}" data-ward="${r.ward}"><span class="ic">‚úÖ</span>C·∫•p TL</button>`);
        const hdActions = !isVoid(r.status) ? `
          <button class="btn btn-danger btn-sm" data-act="void-hd" data-no="${r.contract_no}"><span class="ic">‚õî</span>Hu·ª∑ Hƒê</button>
          ${role==='admin'?`<button class="btn btn-danger btn-sm" data-act="del-hd" data-no="${r.contract_no}">Xo√° Hƒê</button>`:''}` : '';
        card.innerHTML = `
          <h4>${hdBadge}</h4>
          <div class="meta">
            <span>Ph∆∞·ªùng: <b>${r.ward}</b></span>
            <span>Ch·ªß: <b>${r.owner_name??''}</b></span>
            <span>T·ªù: <b>${r.sheet_no??''}</b></span>
            <span>Th·ª≠a: <b>${r.parcel_no??''}</b></span>
            <span>TT: <b>${statusLabel}</b></span>
          </div>
          <div class="actions">${tlPart} ${hdActions}</div>`;
        cards.appendChild(card);
      }

      // Attach actions
      const attach=(root)=> root.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click', async (ev)=>{
          const el=ev.currentTarget, act=el.getAttribute('data-act');
          try{
            if (act==='issue-tl'){
              const contractNo=el.getAttribute('data-no'), w=el.getAttribute('data-ward');
              el.disabled=true; el.textContent='ƒêang c·∫•p...';
              const { data, error } = await sb.rpc('issue_termination_global',{ p_ward:w, p_contract_no:contractNo, p_request_id:crypto.randomUUID(), p_note:null });
              if (error) throw error;
              const row = Array.isArray(data) ? data[0] : data;
              const tno = row?.termination_no || '(kh√¥ng l·∫•y ƒë∆∞·ª£c s·ªë)';
              toast("ƒê√£ c·∫•p TL: "+tno); await loadContracts();
            }
            if (act==='void-tl'){
              const tlNo=el.getAttribute('data-no');
              const reason=prompt("Nh·∫≠p l√Ω do hu·ª∑ (‚â• 20 k√Ω t·ª±). V√≠ d·ª•: nh·∫≠p sai t√™n ch·ªß / nh·∫ßm th·ª≠a ...");
              if (!reason || reason.trim().length<20){ alert("L√Ω do qu√° ng·∫Øn (‚â•20 k√Ω t·ª±)."); return; }
              el.disabled=true; el.textContent='ƒêang hu·ª∑...';
              const { error } = await sb.rpc('void_record',{ p_entity:'TERMINATION', p_number:tlNo, p_reason_code:'USER_VOID', p_reason_text:reason });
              if (error) throw error;
              toast("ƒê√£ hu·ª∑ TL: "+tlNo); await loadContracts();
            }
            if (act==='void-hd'){
              const hdNo=el.getAttribute('data-no');
              const reason=prompt("Nh·∫≠p l√Ω do hu·ª∑ Hƒê (‚â• 20 k√Ω t·ª±). L∆∞u √Ω: Hƒê c√≥ TL hi·ªáu l·ª±c s·∫Ω kh√¥ng th·ªÉ hu·ª∑.");
              if (!reason || reason.trim().length<20){ alert("L√Ω do qu√° ng·∫Øn (‚â•20 k√Ω t·ª±)."); return; }
              el.disabled=true; el.textContent='ƒêang hu·ª∑...';
              const { error } = await sb.rpc('void_record',{ p_entity:'CONTRACT', p_number:hdNo, p_reason_code:'USER_VOID', p_reason_text:reason });
              if (error) throw error;
              toast("ƒê√£ hu·ª∑ Hƒê: "+hdNo); await loadContracts();
            }
            if (act==='del-tl'){
              const tlNo=el.getAttribute('data-no');
              if (!confirm("Xo√° c·ª©ng TL "+tlNo+"? (ch·ªâ d·ªçn d·ªØ li·ªáu test)")) return;
              el.disabled=true; el.textContent='ƒêang xo√°...';
              const { error } = await sb.rpc('admin_delete_termination',{ p_termination_no:tlNo });
              if (error) throw error;
              toast("ƒê√£ xo√° TL: "+tlNo); await loadContracts();
            }
            if (act==='del-hd'){
              const hdNo=el.getAttribute('data-no');
              if (!confirm("Xo√° c·ª©ng Hƒê "+hdNo+"? (ch·ªâ d·ªçn d·ªØ li·ªáu test)")) return;
              el.disabled=true; el.textContent='ƒêang xo√°...';
              const { error } = await sb.rpc('admin_delete_contract',{ p_contract_no:hdNo });
              if (error) throw error;
              toast("ƒê√£ xo√° Hƒê: "+hdNo); await loadContracts();
            }
          }catch(e){ console.error(e); alert(e.message||e); el.disabled=false; }
        });
      });
      attach(tbody); attach(cards);
    }

    gi('btnReload').onclick = loadContracts;
    gi('btnReload_mobile').onclick = ()=> gi('btnReload').click();

    (async()=>{ await refreshWho(); await loadContracts(); })();
  </script>
</body>
</html>
