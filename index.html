<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>QL Số HĐ & TL – VPĐKLK</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bg:#f6f7fb; --text:#0f172a; --muted:#475569; --line:#e2e8f0; --primary:#2563eb; --warn:#d97706; --card:#fff; --tap:44px }
    html,body{ background:var(--bg); color:var(--text) }
    input,select,button{ min-height:var(--tap) }
    .flat{ border:1px solid var(--line); border-radius:12px; background:var(--card) }
    .btn{ border:1px solid var(--line); border-radius:10px; padding:.55rem 1rem; font-weight:600; background:#fff }
    .btn-primary{ background:var(--primary); color:#fff; border-color:var(--primary) }
    .btn-warn{ background:var(--warn); color:#fff; border-color:var(--warn) }
    .btn-ghost{ background:#f8fafc }
    .btn-sm{ padding:.35rem .7rem; font-size:.92rem }
    .badge{display:inline-block;padding:.18rem .55rem;border-radius:8px;font-weight:700;border:1px solid var(--line)}
    .badge-hd{ background:#e0eaff; color:#1d4ed8 }
    .badge-tl{ background:#fff1e6; color:#a45303 }
    .badge-void{ background:#ffe0e0; color:#b91c1c; text-decoration:line-through; text-decoration-thickness:2px; border-color:#fecaca }
    .table{width:100%} .table th,.table td{ padding:.6rem; border-bottom:1px solid var(--line); vertical-align:top }
    .pill{ display:inline-flex; align-items:center; gap:.4rem; padding:.3rem .7rem; border:1px solid var(--line); border-radius:999px; font-size:.9rem; background:#f1f5f9; color:#334155 }
    .card-row{ border:1px solid var(--line); border-radius:12px; background:#fff; padding:.9rem }
    .card-row h4{ font-weight:700; margin:0 0 .35rem }
    .card-row .meta{ font-size:.92rem; color:#475569; display:flex; flex-wrap:wrap; gap:.45rem .8rem }
    .card-row .actions{ margin-top:.6rem; display:flex; flex-wrap:wrap; gap:.4rem }
    @media (max-width:640px){
      html{ font-size:15px }
      .sticky-actions{ position:sticky; bottom:0; left:0; right:0; background:#ffffffee; backdrop-filter:blur(6px);
        border-top:1px solid var(--line); padding:.6rem; display:flex; gap:.5rem; z-index:30 }
    }
  </style>
</head>
<body>
  <header class="border-b" style="border-color:var(--line);background:#fff;">
    <div class="max-w-6xl mx-auto px-3 py-3 flex items-center gap-3">
      <div class="flex-1 flex items-center gap-4">
        <span class="text-lg md:text-xl font-bold">QL Số HĐ & TL – VPĐKLK</span>
        <nav class="hidden sm:flex gap-3 text-[15px]">
          <a class="pill hover:underline" href="./index.html">Trang chính</a>
          <a id="reportsLink" class="pill hover:underline" href="./reports.html" style="display:none">Báo cáo</a>
        </nav>
      </div>
      <div class="hidden sm:flex items-center gap-2">
        <input id="email" class="flat px-3 py-2 w-64" placeholder="email (vd: user1@vp.local)" autocomplete="username" />
        <input id="password" type="password" class="flat px-3 py-2 w-48" placeholder="mật khẩu" autocomplete="current-password" />
        <button id="btnLogin" class="btn btn-primary">Đăng nhập</button>
        <button id="btnLogout" class="btn btn-ghost">Đăng xuất</button>
      </div>
      <div class="sm:hidden flex gap-2">
        <button id="btnLogin" class="btn btn-primary">Đăng nhập</button>
        <button id="btnLogout" class="btn btn-ghost">Đăng xuất</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-3 py-6">
    <section class="grid md:grid-cols-3 gap-3">
      <div class="flat p-3"><div class="text-[13px] text-slate-500">Người dùng</div><div id="who" class="text-lg font-semibold">Chưa đăng nhập</div></div>
      <div class="flat p-3"><div class="text-[13px] text-slate-500">Vai trò</div><div id="role" class="text-lg font-semibold">–</div></div>
      <div class="flat p-3"><div class="text-[13px] text-slate-500">Phiên</div><div id="session" class="text-lg font-semibold">–</div></div>
    </section>

    <section class="flat p-4 mt-6">
      <h2 class="text-xl font-bold">Cấp số Hợp đồng (đánh số toàn cục)</h2>
      <div class="grid sm:grid-cols-6 grid-cols-2 gap-3 mt-3">
        <div class="sm:col-span-1 col-span-2">
          <label class="text-sm text-slate-600">Phường</label>
          <select id="ward" class="flat px-3 py-2 w-full"><option>LK</option><option>HG</option><option>BL</option><option>BV</option><option>XL</option></select>
        </div>
        <div class="sm:col-span-2 col-span-2">
          <label class="text-sm text-slate-600">Tên chủ đất</label>
          <input id="owner" class="flat px-3 py-2 w-full" placeholder="Nguyễn Văn A" autocomplete="name" />
        </div>
        <div><label class="text-sm text-slate-600">Số tờ</label><input id="sheet" type="number" class="flat px-3 py-2 w-full" /></div>
        <div><label class="text-sm text-slate-600">Số thửa</label><input id="parcel" type="number" class="flat px-3 py-2 w-full" /></div>
        <div class="sm:col-span-2 col-span-2"><label class="text-sm text-slate-600">Ghi chú</label><input id="note" class="flat px-3 py-2 w-full" /></div>
      </div>
      <div class="mt-3 flex gap-2 items-center">
        <button id="btnIssueHD" class="btn btn-primary">Cấp số HĐ</button>
        <div id="hdResult" class="text-lg"></div>
      </div>
    </section>

    <section class="flat p-4 mt-6">
      <div class="flex items-center justify-between gap-3">
        <h2 class="text-xl font-bold">Danh sách Hợp đồng gần đây</h2>
        <div class="flex gap-2 items-center">
          <select id="filterWard" class="flat px-2 py-2">
            <option value="">Tất cả phường</option><option>LK</option><option>HG</option><option>BL</option><option>BV</option><option>XL</option>
          </select>
          <button id="btnReload" class="btn">Tải lại</button>
        </div>
      </div>
      <div class="mt-3 overflow-x-auto hidden sm:block">
        <table class="table">
          <thead class="text-left text-slate-500"><tr><th>Số HĐ</th><th>Phường</th><th>Chủ đất</th><th>Tờ</th><th>Thửa</th><th>Trạng thái</th><th>Hành động</th></tr></thead>
          <tbody id="contractsBody"></tbody>
        </table>
      </div>
      <div id="contractsCards" class="mt-3 grid gap-3 sm:hidden"></div>

      <p class="text-sm text-slate-500 mt-3">
        Trạng thái hiển thị: <b>Chưa thanh lý</b> / <b>Hoàn thành</b> / <b>Đã huỷ</b>. &nbsp;Số huỷ:
        <span class="badge badge-void">VD HĐ bị huỷ</span>
      </p>
    </section>

    <div class="sticky-actions sm:hidden">
      <button id="btnIssueHD_mobile" class="btn btn-primary flex-1">Cấp số HĐ</button>
      <button id="btnReload_mobile" class="btn">Tải lại</button>
    </div>
  </main>

  <div id="toast" class="fixed bottom-4 right-4 hidden text-white px-4 py-3 rounded-lg" style="background:#0f172a"></div>

  <!-- Login Modal -->
  <dialog id="loginDialog" class="rounded-xl p-0 w-[92vw] max-w-md">
    <form id="loginForm" method="dialog" class="p-5">
      <h3 class="text-lg font-semibold mb-3">Đăng nhập</h3>
      <div class="space-y-3">
        <div><label class="text-sm text-slate-600">Email</label><input id="emailModal" class="flat px-3 py-2 w-full" placeholder="vd: user1@vp.local" autocomplete="username" /></div>
        <div><label class="text-sm text-slate-600">Mật khẩu</label><input id="passwordModal" type="password" class="flat px-3 py-2 w-full" placeholder="mật khẩu" autocomplete="current-password" /></div>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button type="button" id="btnCloseLogin" class="btn btn-ghost">Huỷ</button>
        <button type="submit" id="btnDoLogin" class="btn btn-primary">Đăng nhập</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://nefjhmhzfuuwxxhhjaei.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZmpobWh6ZnV1d3h4aGhqYWVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTI3MzQsImV4cCI6MjA3MTY4ODczNH0.2vT6kw0uvSTr49cGLSrsZbT6qtPJ_mYzXsu7PGJpGrY";  /* ← dán ANON KEY */
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const gi = (id)=>document.getElementById(id);
    const toast = (msg)=>{const t=gi('toast');t.textContent=msg;t.classList.remove('hidden');setTimeout(()=>t.classList.add('hidden'),2200);};
    const getSession = async()=> (await sb.auth.getSession()).data.session;
    const isVoid = (st)=> (st||'').toLowerCase()==='void';

    async function fetchRole(){
      const { data, error } = await sb.rpc('get_my_role');
      if (error){ console.error(error); return ''; }
      return data || '';
    }
    function vnContractStatus(r, tlMap){ return isVoid(r.status) ? 'Đã huỷ' : (tlMap.has(r.id) ? 'Hoàn thành' : 'Chưa thanh lý'); }

    async function refreshWho(){
      const session = await getSession();
      const reportsLink = document.getElementById('reportsLink');
      if (!session){
        gi('who').textContent="Chưa đăng nhập"; gi('role').textContent="–"; gi('session').textContent="–";
        if (reportsLink) reportsLink.style.display='none'; return;
      }
      const email = (session.user.email || '').toLowerCase();
      const role  = await fetchRole();
      gi('who').textContent = session.user.email || '';
      gi('role').textContent = role || '(chưa gán)';
      gi('session').textContent = session.access_token.slice(0,12)+"…";
      const showReports = (role==='admin'||role==='report_admin'|| email==='admin@vp.local'||email==='admin1@vp.local');
      if (reportsLink) reportsLink.style.display = showReports ? '' : 'none';
    }

    // Modal login
    const dlg=gi('loginDialog'), emailModal=gi('emailModal'), passwordModal=gi('passwordModal');
    const openLoginDialog=()=>{ if(!dlg.open) dlg.showModal(); setTimeout(()=>emailModal.focus(),30); };
    const closeLoginDialog=()=>{ if(dlg.open) dlg.close(); };
    gi('btnCloseLogin').onclick = closeLoginDialog;
    gi('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const { error } = await sb.auth.signInWithPassword({ email: emailModal.value.trim(), password: passwordModal.value });
      if (error){ alert(error.message); return; }
      closeLoginDialog(); toast("Đăng nhập thành công"); await refreshWho(); await loadContracts();
    });

    // Header login
    document.querySelectorAll('#btnLogin').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const desktop = window.matchMedia('(min-width: 640px)').matches;
        if (desktop){
          const email = gi('email').value.trim(), password = gi('password').value;
          if(!email||!password){ openLoginDialog(); return; }
          const { error } = await sb.auth.signInWithPassword({ email, password });
          if (error){ alert(error.message); return; }
          toast("Đăng nhập thành công"); await refreshWho(); await loadContracts();
        } else openLoginDialog();
      });
    });
    document.querySelectorAll('#btnLogout').forEach(btn=> btn.addEventListener('click', async()=>{ await sb.auth.signOut(); await refreshWho(); }));

    // ====== Cấp số HĐ: ĐÃ CÓ fallback ======
    const issueHd = async()=>{
      const s=await getSession(); if(!s){ openLoginDialog(); return; }
      try{
        const payload={
          p_ward:gi('ward').value,
          p_owner_name:gi('owner').value,
          p_sheet_no:+gi('sheet').value||null,
          p_parcel_no:+gi('parcel').value||null,
          p_request_id:crypto.randomUUID(),
          p_note:gi('note').value||null
        };
        const { data, error } = await sb.rpc('issue_contract_global', payload);
        if (error) throw error;

        const row = Array.isArray(data) ? data[0] : data;
        let cno = row?.contract_no;

        if (!cno){
          const { data: last } = await sb.from('contract')
            .select('contract_no').order('id',{ascending:false}).limit(1);
          cno = last?.[0]?.contract_no || '(không lấy được số)';
        }

        gi('hdResult').innerHTML = `<span class="badge badge-hd">${cno}</span>`;
        toast("Đã cấp: " + cno);
        await loadContracts();
      }catch(e){ console.error(e); alert("Lỗi: "+(e.message||e)); }
    };
    gi('btnIssueHD').onclick = issueHd;
    gi('btnIssueHD_mobile').onclick = ()=> gi('btnIssueHD').click();

    // ====== Load list & actions ======
    async function loadContracts(){
      const s=await getSession(); if(!s) return;
      const role = await fetchRole();
      const ward=gi('filterWard').value;
      let q=sb.from('contract').select('id,contract_no,ward,owner_name,sheet_no,parcel_no,status').order('id',{ascending:false}).limit(100);
      if (ward) q=q.eq('ward', ward);
      const { data:contracts, error } = await q;
      if (error){ alert(error.message); return; }

      const ids=contracts.map(r=>r.id); const tlMap=new Map();
      if (ids.length){
        const { data: tls, error:e2 } = await sb.from('termination')
          .select('contract_id,termination_no,status').in('contract_id', ids).eq('status','issued');
        if (e2){ alert(e2.message); return; }
        for (const t of tls) tlMap.set(t.contract_id, t.termination_no);
      }

      const tbody=gi('contractsBody'); tbody.innerHTML='';
      for (const r of contracts){
        const tlNo=tlMap.get(r.id);
        const actions=[];
        if (isVoid(r.status)){
          actions.push('<span class="text-slate-400">—</span>');
        } else {
          if (tlNo){
            actions.push(`<span class="badge badge-tl">${tlNo}</span>`);
            actions.push(`<button class="btn btn-ghost btn-sm" data-act="void-tl" data-no="${tlNo}">Huỷ TL</button>`);
            if (role==='admin') actions.push(`<button class="btn btn-ghost btn-sm" data-act="del-tl" data-no="${tlNo}">Xoá TL</button>`);
          } else {
            actions.push(`<button class="btn btn-warn btn-sm" data-act="issue-tl" data-no="${r.contract_no}" data-ward="${r.ward}">Cấp TL</button>`);
          }
          actions.push(`<button class="btn btn-ghost btn-sm" data-act="void-hd" data-no="${r.contract_no}">Huỷ HĐ</button>`);
          if (role==='admin') actions.push(`<button class="btn btn-ghost btn-sm" data-act="del-hd" data-no="${r.contract_no}">Xoá HĐ</button>`);
        }
        const statusLabel = vnContractStatus(r, tlMap);
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><span class="badge ${isVoid(r.status)?'badge-void':'badge-hd'}">${r.contract_no}</span></td>
          <td>${r.ward}</td><td>${r.owner_name??''}</td>
          <td>${r.sheet_no??''}</td><td>${r.parcel_no??''}</td>
          <td>${statusLabel}</td><td class="space-x-1 space-y-1">${actions.join(' ')}</td>`;
        tbody.appendChild(tr);
      }

      const cards=gi('contractsCards'); cards.innerHTML='';
      for (const r of contracts){
        const tlNo=tlMap.get(r.id);
        const statusLabel = vnContractStatus(r, tlMap);
        const card=document.createElement('div'); card.className='card-row';
        const hdBadge=`<span class="badge ${isVoid(r.status)?'badge-void':'badge-hd'}">${r.contract_no}</span>`;
        const tlPart = isVoid(r.status) ? '<span class="text-slate-400">—</span>' :
          (tlNo ? `<span class="badge badge-tl">${tlNo}</span>
                   <button class="btn btn-ghost btn-sm" data-act="void-tl" data-no="${tlNo}">Huỷ TL</button>
                   ${role==='admin'?`<button class="btn btn-ghost btn-sm" data-act="del-tl" data-no="${tlNo}">Xoá TL</button>`:''}`
               : `<button class="btn btn-warn btn-sm" data-act="issue-tl" data-no="${r.contract_no}" data-ward="${r.ward}">Cấp TL</button>`);
        const hdActions = !isVoid(r.status) ? `
          <button class="btn btn-ghost btn-sm" data-act="void-hd" data-no="${r.contract_no}">Huỷ HĐ</button>
          ${role==='admin'?`<button class="btn btn-ghost btn-sm" data-act="del-hd" data-no="${r.contract_no}">Xoá HĐ</button>`:''}` : '';
        card.innerHTML = `
          <h4>${hdBadge}</h4>
          <div class="meta">
            <span>Phường: <b>${r.ward}</b></span>
            <span>Chủ: <b>${r.owner_name??''}</b></span>
            <span>Tờ: <b>${r.sheet_no??''}</b></span>
            <span>Thửa: <b>${r.parcel_no??''}</b></span>
            <span>TT: <b>${statusLabel}</b></span>
          </div>
          <div class="actions">${tlPart} ${hdActions}</div>`;
        cards.appendChild(card);
      }

      const attach=(root)=> root.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click', async (ev)=>{
          const el=ev.currentTarget, act=el.getAttribute('data-act');
          try{
            if (act==='issue-tl'){
              const contractNo=el.getAttribute('data-no'), w=el.getAttribute('data-ward');
              el.disabled=true; el.textContent='Đang cấp...';
              const { data, error } = await sb.rpc('issue_termination_global',{ p_ward:w, p_contract_no:contractNo, p_request_id:crypto.randomUUID(), p_note:null });
              if (error) throw error;
              const row = Array.isArray(data) ? data[0] : data;
              const tno = row?.termination_no || '(không lấy được số)';
              toast("Đã cấp TL: "+tno); await loadContracts();
            }
            if (act==='void-tl'){
              const tlNo=el.getAttribute('data-no');
              const reason=prompt("Nhập lý do huỷ (≥ 20 ký tự). Ví dụ: nhập sai tên chủ / nhầm thửa ...");
              if (!reason || reason.trim().length<20){ alert("Lý do quá ngắn (≥20 ký tự)."); return; }
              el.disabled=true; el.textContent='Đang huỷ...';
              const { error } = await sb.rpc('void_record',{ p_entity:'TERMINATION', p_number:tlNo, p_reason_code:'USER_VOID', p_reason_text:reason });
              if (error) throw error;
              toast("Đã huỷ TL: "+tlNo); await loadContracts();
            }
            if (act==='void-hd'){
              const hdNo=el.getAttribute('data-no');
              const reason=prompt("Nhập lý do huỷ HĐ (≥ 20 ký tự). Lưu ý: HĐ có TL hiệu lực sẽ không thể huỷ.");
              if (!reason || reason.trim().length<20){ alert("Lý do quá ngắn (≥20 ký tự)."); return; }
              el.disabled=true; el.textContent='Đang huỷ...';
              const { error } = await sb.rpc('void_record',{ p_entity:'CONTRACT', p_number:hdNo, p_reason_code:'USER_VOID', p_reason_text:reason });
              if (error) throw error;
              toast("Đã huỷ HĐ: "+hdNo); await loadContracts();
            }
            if (act==='del-tl'){
              const tlNo=el.getAttribute('data-no');
              if (!confirm("Xoá cứng TL "+tlNo+"? (chỉ dọn dữ liệu test)")) return;
              el.disabled=true; el.textContent='Đang xoá...';
              const { error } = await sb.rpc('admin_delete_termination',{ p_termination_no:tlNo });
              if (error) throw error;
              toast("Đã xoá TL: "+tlNo); await loadContracts();
            }
            if (act==='del-hd'){
              const hdNo=el.getAttribute('data-no');
              if (!confirm("Xoá cứng HĐ "+hdNo+"? (chỉ dọn dữ liệu test)")) return;
              el.disabled=true; el.textContent='Đang xoá...';
              const { error } = await sb.rpc('admin_delete_contract',{ p_contract_no:hdNo });
              if (error) throw error;
              toast("Đã xoá HĐ: "+hdNo); await loadContracts();
            }
          }catch(e){ console.error(e); alert(e.message||e); el.disabled=false; }
        });
      });
      attach(tbody); attach(cards);
    }

    gi('btnReload').onclick = loadContracts;
    gi('btnReload_mobile').onclick = ()=> gi('btnReload').click();

    (async()=>{ await refreshWho(); await loadContracts(); })();
  </script>
</body>
</html>
