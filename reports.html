<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Báo cáo – QL Số HĐ & TL</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{ --bg:#f6f7fb; --text:#0f172a; --muted:#475569; --line:#e2e8f0; --primary:#2563eb; --card:#fff; --tap:44px }
    html,body{ background:var(--bg); color:var(--text) }
    .flat{ border:1px solid var(--line); border-radius:12px; background:var(--card) }
    input,select,button{ min-height: var(--tap) }
    .btn{ border:1px solid var(--line); border-radius:10px; padding:.55rem 1rem; font-weight:600; background:#fff }
    .btn-primary{ background:var(--primary); color:#fff; border-color:var(--primary) }
    .btn-ghost{ background:#f8fafc }
    .kpi{ display:flex; flex-direction:column; gap:.35rem }
    .kpi .label{ color:var(--muted); font-size:13px }
    .kpi .val{ font-size:1.5rem; font-weight:800 }
    @media (max-width: 640px){ html{ font-size:15px } .auth-bar{ position:sticky; top:0; background:#fff; z-index:40; padding:.5rem; border-bottom:1px solid var(--line)} canvas{ max-height:220px } }
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="border-b" style="border-color:#e2e8f0;background:#fff;">
    <div class="max-w-6xl mx-auto px-3 py-3 flex items-center gap-3">
      <div class="flex-1 flex items-center gap-3">
        <span class="text-lg md:text-xl font-bold">Báo cáo – QL Số HĐ & TL</span>
        <nav class="hidden sm:flex gap-3 text-[15px]">
          <a class="underline-offset-4 hover:underline" href="./index.html">Trang chính</a>
          <a class="underline-offset-4 hover:underline" href="./reports.html">Báo cáo</a>
        </nav>
      </div>
      <div class="auth-bar flex items-center gap-2">
        <input id="email" class="hidden sm:block flat px-3 py-2 w-64" placeholder="email" autocomplete="username" />
        <input id="password" type="password" class="hidden sm:block flat px-3 py-2 w-48" placeholder="mật khẩu" autocomplete="current-password" />
        <button id="btnLogin" class="btn btn-primary">Đăng nhập</button>
        <button id="btnLogout" class="btn btn-ghost">Đăng xuất</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-3 py-6">
    <!-- Filters -->
    <section class="flat p-4">
      <div class="grid grid-cols-2 sm:grid-cols-6 gap-3">
        <div><label class="text-sm text-slate-600">Từ ngày</label><input id="from" type="date" class="flat px-3 py-2 w-full"/></div>
        <div><label class="text-sm text-slate-600">Đến ngày</label><input id="to" type="date" class="flat px-3 py-2 w-full"/></div>
        <div><label class="text-sm text-slate-600">Phường</label>
          <select id="ward" class="flat px-3 py-2 w-full"><option value="">Tất cả</option><option>LK</option><option>HG</option><option>BL</option><option>BV</option><option>XL</option></select>
        </div>
        <div><label class="text-sm text-slate-600">Kỳ</label>
          <select id="grain" class="flat px-3 py-2 w-full">
            <option value="day">Theo ngày</option>
            <option value="week">Theo tuần</option>
            <option value="month" selected>Theo tháng</option>
            <option value="year">Theo năm</option>
          </select>
        </div>
        <div class="flex items-end gap-2">
          <button id="btnRun" class="btn btn-primary">Chạy báo cáo</button>
          <button id="btnExport" class="btn">Xuất Excel</button>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid md:grid-cols-4 gap-3 mt-4">
      <div class="flat p-3 kpi"><div class="label">Tổng HĐ</div><div id="kpiHD" class="val">–</div></div>
      <div class="flat p-3 kpi"><div class="label">Tổng TL</div><div id="kpiTL" class="val">–</div></div>
      <div class="flat p-3 kpi"><div class="label">HĐ/Ngày TB</div><div id="kpiHDavg" class="val">–</div></div>
      <div class="flat p-3 kpi"><div class="label">TL/Ngày TB</div><div id="kpiTLavg" class="val">–</div></div>
    </section>

    <!-- Charts -->
    <section class="grid md:grid-cols-2 gap-3 mt-4">
      <div class="flat p-4"><h3 class="font-semibold mb-2">Hợp đồng</h3><canvas id="chartHD" height="160"></canvas></div>
      <div class="flat p-4"><h3 class="font-semibold mb-2">Thanh lý</h3><canvas id="chartTL" height="160"></canvas></div>
    </section>

    <!-- Table -->
    <section class="flat p-4 mt-4">
      <h3 class="font-semibold mb-2">Bảng dữ liệu (tổng hợp theo kỳ)</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="text-left text-slate-500"><tr><th class="p-2">Kỳ</th><th class="p-2">HĐ</th><th class="p-2">TL</th></tr></thead>
          <tbody id="reportBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Login Modal -->
  <dialog id="loginDialog" class="rounded-xl p-0 w-[92vw] max-w-md">
    <form id="loginForm" method="dialog" class="p-5">
      <h3 class="text-lg font-semibold mb-3">Đăng nhập</h3>
      <div class="space-y-3">
        <div><label class="text-sm text-slate-600">Email</label><input id="emailModal" class="flat px-3 py-2 w-full" placeholder="vd: admin1@vp.local" autocomplete="username" /></div>
        <div><label class="text-sm text-slate-600">Mật khẩu</label><input id="passwordModal" type="password" class="flat px-3 py-2 w-full" placeholder="mật khẩu" autocomplete="current-password" /></div>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button type="button" id="btnCloseLogin" class="btn btn-ghost">Huỷ</button>
        <button type="submit" id="btnDoLogin" class="btn btn-primary">Đăng nhập</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL="https://nefjhmhzfuuwxxhhjaei.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZmpobWh6ZnV1d3h4aGhqYWVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTI3MzQsImV4cCI6MjA3MTY4ODczNH0.2vT6kw0uvSTr49cGLSrsZbT6qtPJ_mYzXsu7PGJpGrY";
    const sb=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
    const gi=id=>document.getElementById(id);
    let charts={hd:null,tl:null};

    const getSession = async()=> (await sb.auth.getSession()).data.session;
    const getRole = (s)=> s?.user?.app_metadata?.role || "";

    async function guardReports(){
      const s = await getSession();
      if (!s) return; // chưa đăng nhập → bấm "Chạy báo cáo" sẽ yêu cầu
      const role = getRole(s);
      if (role!=='admin' && role!=='report_admin'){
        document.body.innerHTML = `
          <div style="max-width:720px;margin:40px auto;font-family:system-ui">
            <h1 style="font-size:20px;font-weight:700">Truy cập bị hạn chế</h1>
            <p>Chức năng báo cáo chỉ dành cho tài khoản <b>admin</b> hoặc <b>report_admin</b>.</p>
            <p><a href="./index.html" style="color:#2563eb;text-decoration:underline">Quay lại Trang chính</a></p>
          </div>`;
      }
    }
    guardReports();

    // Modal login
    const dlg=gi('loginDialog'), emailModal=gi('emailModal'), passwordModal=gi('passwordModal');
    const openLoginDialog=()=>{ if(!dlg.open) dlg.showModal(); setTimeout(()=>emailModal.focus(),30); };
    const closeLoginDialog=()=>{ if(dlg.open) dlg.close(); };
    gi('btnCloseLogin').onclick = closeLoginDialog;
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      try{
        const { error } = await sb.auth.signInWithPassword({ email: emailModal.value.trim(), password: passwordModal.value });
        if (error) throw error;
        closeLoginDialog(); await runReport();
      }catch(err){ console.error(err); alert(err.message||err); }
    });

    // Header login: desktop direct / mobile modal
    document.getElementById('btnLogin').onclick = async ()=>{
      const desktop = window.matchMedia('(min-width: 640px)').matches;
      if (desktop){
        const email = gi('email').value.trim(), password = gi('password').value;
        if (!email || !password){ alert("Chưa nhập email/mật khẩu"); return; }
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error){ alert(error.message); return; }
        await runReport();
      } else {
        openLoginDialog();
      }
    };
    document.getElementById('btnLogout').onclick = async ()=>{ await sb.auth.signOut(); };

    function fmtKey(d, grain){
      const dt=new Date(d);
      if (grain==='year') return String(dt.getFullYear());
      if (grain==='month') return dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,'0');
      if (grain==='week'){
        const t=new Date(dt); const day=(t.getDay()+6)%7; t.setDate(t.getDate()-day);
        const onejan=new Date(t.getFullYear(),0,1);
        const week=Math.ceil((((t-onejan)/86400000)+onejan.getDay()+1)/7);
        return t.getFullYear()+"-W"+String(week).padStart(2,'0');
      }
      return dt.toISOString().slice(0,10);
    }

    async function requireLogin(){ const s=await getSession(); if(!s){ openLoginDialog(); return false; } return true; }

    async function runReport(){
      if(!await requireLogin()) return;
      const from=gi('from').value || new Date(new Date().getFullYear(),0,1).toISOString().slice(0,10);
      const to=gi('to').value || new Date().toISOString().slice(0,10);
      const ward=gi('ward').value; const grain=gi('grain').value;

      let q1=sb.from('contract').select('issued_date,ward').gte('issued_date',from).lte('issued_date',to);
      let q2=sb.from('termination').select('terminated_date,ward').gte('terminated_date',from).lte('terminated_date',to);
      if (ward){ q1=q1.eq('ward',ward); q2=q2.eq('ward',ward); }
      const [{data:dHD,error:e1},{data:dTL,error:e2}] = await Promise.all([q1,q2]);
      if (e1||e2){ alert((e1||e2).message); return; }

      const agg=new Map();
      for(const r of dHD){ const k=fmtKey(r.issued_date,grain); agg.set(k,{key:k,hd:(agg.get(k)?.hd||0)+1,tl:agg.get(k)?.tl||0}); }
      for(const r of dTL){ const k=fmtKey(r.terminated_date,grain); agg.set(k,{key:k,hd:agg.get(k)?.hd||0,tl:(agg.get(k)?.tl||0)+1}); }
      const rows=Array.from(agg.values()).sort((a,b)=>a.key.localeCompare(b.key));

      const totalHD=dHD.length, totalTL=dTL.length;
      gi('kpiHD').textContent=totalHD; gi('kpiTL').textContent=totalTL;
      const days=Math.max(1,(new Date(to)-new Date(from))/86400000);
      gi('kpiHDavg').textContent=(totalHD/days).toFixed(2);
      gi('kpiTLavg').textContent=(totalTL/days).toFixed(2);

      const tbody=gi('reportBody'); tbody.innerHTML='';
      rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="p-2">${r.key}</td><td class="p-2">${r.hd}</td><td class="p-2">${r.tl}</td>`; tbody.appendChild(tr); });

      const labels=rows.map(r=>r.key), hd=rows.map(r=>r.hd), tl=rows.map(r=>r.tl);
      charts.hd?.destroy(); charts.tl?.destroy();
      charts.hd=new Chart(document.getElementById('chartHD'),{ type:'bar', data:{labels, datasets:[{label:'Hợp đồng', data:hd}]}, options:{maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{maxRotation:60,autoSkip:true}}}} });
      charts.tl=new Chart(document.getElementById('chartTL'),{ type:'bar', data:{labels, datasets:[{label:'Thanh lý', data:tl}]}, options:{maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{maxRotation:60,autoSkip:true}}}} });

      window.__reportRows=rows; window.__reportMeta={from,to,ward,grain,generatedAt:new Date().toISOString()};
    }

    function exportExcel(){
      const rows=window.__reportRows||[], meta=window.__reportMeta||{};
      const sheet=[["Báo cáo QL Số HĐ & TL"],["Kỳ:",meta.grain],["Từ ngày:",meta.from,"Đến ngày:",meta.to,"Phường:",meta.ward||"Tất cả"],[],["Kỳ","Hợp đồng","Thanh lý"],...rows.map(r=>[r.key,r.hd,r.tl])];
      const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(sheet);
      XLSX.utils.book_append_sheet(wb,ws,"BaoCao"); XLSX.writeFile(wb,"BaoCao_HD_TL.xlsx");
    }

    document.getElementById('btnRun').onclick=runReport;
    document.getElementById('btnExport').onclick=exportExcel;

    const today=new Date(); const y0=new Date(today.getFullYear(),0,1).toISOString().slice(0,10);
    gi('from').value=y0; gi('to').value=today.toISOString().slice(0,10);
  </script>
</body>
</html>
