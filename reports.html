<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Báo cáo – QL Số HĐ & TL</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>.card{border:1px solid #e5e7eb;border-radius:1rem;padding:1rem;background:#fff}</style>
</head>
<body class="bg-slate-50">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-3 py-3 flex items-center gap-3">
      <div class="flex-1 flex items-center gap-3">
        <span class="text-xl font-bold">Báo cáo – QL Số HĐ & TL</span>
        <nav class="hidden sm:flex gap-4 ml-4 text-slate-600">
          <a class="hover:text-slate-900" href="./index.html">Trang chính</a>
          <a class="hover:text-slate-900" href="./reports.html">Báo cáo</a>
        </nav>
      </div>
      <div class="flex items-center gap-2">
        <input id="email" class="hidden sm:block border rounded px-3 py-2" placeholder="email" />
        <input id="password" type="password" class="hidden sm:block border rounded px-3 py-2" placeholder="mật khẩu" />
        <button id="btnLogin" class="px-4 py-2 rounded bg-blue-600 text-white">Đăng nhập</button>
        <button id="btnLogout" class="px-4 py-2 rounded bg-slate-100">Đăng xuất</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-3 py-6">
    <section class="card">
      <div class="grid md:grid-cols-6 gap-3">
        <div><label class="text-sm">Từ ngày</label><input id="from" type="date" class="border rounded w-full px-3 py-2"/></div>
        <div><label class="text-sm">Đến ngày</label><input id="to" type="date" class="border rounded w-full px-3 py-2"/></div>
        <div><label class="text-sm">Phường</label>
          <select id="ward" class="border rounded w-full px-3 py-2"><option value="">Tất cả</option><option>LK</option><option>HG</option><option>BL</option><option>BV</option><option>XL</option></select>
        </div>
        <div><label class="text-sm">Kỳ</label>
          <select id="grain" class="border rounded w-full px-3 py-2">
            <option value="day">Theo ngày</option>
            <option value="week">Theo tuần</option>
            <option value="month" selected>Theo tháng</option>
            <option value="year">Theo năm</option>
          </select>
        </div>
        <div class="flex items-end gap-2">
          <button id="btnRun" class="px-4 py-2 rounded bg-blue-600 text-white">Chạy báo cáo</button>
          <button id="btnExport" class="px-4 py-2 rounded bg-emerald-600 text-white">Xuất Excel</button>
        </div>
      </div>
    </section>

    <section class="grid md:grid-cols-4 gap-3 mt-4">
      <div class="card"><div class="text-slate-500">Tổng HĐ</div><div id="kpiHD" class="text-2xl font-bold">–</div></div>
      <div class="card"><div class="text-slate-500">Tổng TL</div><div id="kpiTL" class="text-2xl font-bold">–</div></div>
      <div class="card"><div class="text-slate-500">HĐ/Ngày TB</div><div id="kpiHDavg" class="text-2xl font-bold">–</div></div>
      <div class="card"><div class="text-slate-500">TL/Ngày TB</div><div id="kpiTLavg" class="text-2xl font-bold">–</div></div>
    </section>

    <section class="grid md:grid-cols-2 gap-3 mt-4">
      <div class="card"><h3 class="font-semibold mb-2">Hợp đồng</h3><canvas id="chartHD" height="140"></canvas></div>
      <div class="card"><h3 class="font-semibold mb-2">Thanh lý</h3><canvas id="chartTL" height="140"></canvas></div>
    </section>

    <section class="card mt-4">
      <h3 class="font-semibold mb-2">Bảng dữ liệu</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full" id="reportTable">
          <thead class="text-left text-slate-500"><tr><th class="p-2">Kỳ</th><th class="p-2">HĐ</th><th class="p-2">TL</th></tr></thead>
          <tbody id="reportBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL="https://nefjhmhzfuuwxxhhjaei.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5lZmpobWh6ZnV1d3h4aGhqYWVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTI3MzQsImV4cCI6MjA3MTY4ODczNH0.2vT6kw0uvSTr49cGLSrsZbT6qtPJ_mYzXsu7PGJpGrY";
    const sb=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
    const gi=id=>document.getElementById(id);
    let charts={hd:null,tl:null};

    // Chặn truy cập nếu không phải admin/report_admin
    async function guardReports(){
      const {data:{session}}=await sb.auth.getSession();
      if(!session) return; // chưa login → vẫn nhìn thấy form, sẽ bị yêu cầu login khi chạy
      const role=session.user.app_metadata?.role;
      if(role!=='admin' && role!=='report_admin'){
        document.body.innerHTML = `
          <div style="max-width:720px;margin:40px auto;font-family:system-ui">
            <h1 style="font-size:20px;font-weight:700">Truy cập bị hạn chế</h1>
            <p>Chức năng báo cáo chỉ dành cho tài khoản <b>admin</b> hoặc <b>report_admin</b>.</p>
            <p><a href="./index.html" style="color:#2563eb;text-decoration:underline">Quay lại Trang chính</a></p>
          </div>`;
      }
    }
    guardReports();

    function fmtKey(d, grain){
      const dt = new Date(d);
      if (grain==='year') return String(dt.getFullYear());
      if (grain==='month') return dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,'0');
      if (grain==='week'){
        const t=new Date(dt); const day=(t.getDay()+6)%7; t.setDate(t.getDate()-day);
        const onejan=new Date(t.getFullYear(),0,1);
        const week=Math.ceil((((t-onejan)/86400000)+onejan.getDay()+1)/7);
        return t.getFullYear()+"-W"+String(week).padStart(2,'0');
      }
      return dt.toISOString().slice(0,10);
    }

    async function requireLogin(){
      const { data: { session } } = await sb.auth.getSession();
      if (!session){
        const email = gi('email').value.trim(), password = gi('password').value;
        if (!email || !password) { alert("Chưa đăng nhập"); return false; }
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) { alert(error.message); return false; }
      }
      return true;
    }

    async function runReport(){
      if(!await requireLogin()) return;

      const from = gi('from').value || new Date(new Date().getFullYear(),0,1).toISOString().slice(0,10);
      const to   = gi('to').value   || new Date().toISOString().slice(0,10);
      const ward = gi('ward').value;
      const grain= gi('grain').value;

      let q1 = sb.from('contract').select('issued_date,ward').gte('issued_date', from).lte('issued_date', to);
      let q2 = sb.from('termination').select('terminated_date,ward').gte('terminated_date', from).lte('terminated_date', to);
      if (ward){ q1=q1.eq('ward', ward); q2=q2.eq('ward', ward); }
      const [{ data: dHD, error: e1 }, { data: dTL, error: e2 }] = await Promise.all([q1, q2]);
      if (e1 || e2){ alert((e1||e2).message); return; }

      const agg=new Map();
      for(const r of dHD){ const key=fmtKey(r.issued_date,grain); agg.set(key,{key,hd:(agg.get(key)?.hd||0)+1,tl:agg.get(key)?.tl||0}); }
      for(const r of dTL){ const key=fmtKey(r.terminated_date,grain); agg.set(key,{key,hd:agg.get(key)?.hd||0,tl:(agg.get(key)?.tl||0)+1}); }
      const rows=Array.from(agg.values()).sort((a,b)=>a.key.localeCompare(b.key));

      const totalHD=dHD.length, totalTL=dTL.length;
      gi('kpiHD').textContent=totalHD;
      gi('kpiTL').textContent=totalTL;
      const days=Math.max(1,(new Date(to)-new Date(from))/86400000);
      gi('kpiHDavg').textContent=(totalHD/days).toFixed(2);
      gi('kpiTLavg').textContent=(totalTL/days).toFixed(2);

      const tbody=gi('reportBody'); tbody.innerHTML='';
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="p-2">${r.key}</td><td class="p-2">${r.hd}</td><td class="p-2">${r.tl}</td>`;
        tbody.appendChild(tr);
      });

      const labels=rows.map(r=>r.key), hd=rows.map(r=>r.hd), tl=rows.map(r=>r.tl);
      charts.hd?.destroy(); charts.tl?.destroy();
      charts.hd=new Chart(document.getElementById('chartHD'), { type:'bar', data:{ labels, datasets:[{ label:'Hợp đồng', data: hd }] } });
      charts.tl=new Chart(document.getElementById('chartTL'), { type:'bar', data:{ labels, datasets:[{ label:'Thanh lý', data: tl }] } });

      window.__reportRows=rows;
      window.__reportMeta={from,to,ward,grain,generatedAt:new Date().toISOString()};
    }

    function exportExcel(){
      const rows=window.__reportRows||[];
      const meta=window.__reportMeta||{};
      const sheet=[
        ["Báo cáo QL Số HĐ & TL"],
        ["Kỳ:", meta.grain],
        ["Từ ngày:", meta.from, "Đến ngày:", meta.to, "Phường:", meta.ward || "Tất cả"],
        [],
        ["Kỳ","Hợp đồng","Thanh lý"],
        ...rows.map(r=>[r.key, r.hd, r.tl]),
      ];
      const wb=XLSX.utils.book_new();
      const ws=XLSX.utils.aoa_to_sheet(sheet);
      XLSX.utils.book_append_sheet(wb, ws, "BaoCao");
      XLSX.writeFile(wb, "BaoCao_HD_TL.xlsx");
    }

    document.getElementById('btnRun').onclick=runReport;
    document.getElementById('btnExport').onclick=exportExcel;

    const today=new Date();
    const y0=new Date(today.getFullYear(),0,1).toISOString().slice(0,10);
    gi('from').value=y0; gi('to').value=today.toISOString().slice(0,10);

    document.getElementById('btnLogin').onclick=async()=>{ const ok=await requireLogin(); if(ok) runReport(); };
    document.getElementById('btnLogout').onclick=async()=>{ await sb.auth.signOut(); };
  </script>
</body>
</html>

